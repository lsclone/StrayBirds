---
layout: post
title: Android JNI 开发详解
category: 技术
---

*参考网址：* [Java Native Interface (JNI)](https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html "Markdown")

####一、 JNI环境搭建: 

可以参考Android NDK开发详解进行如下操作：

* install jdk and set **JAVA_HOME** win-system environment variable
* install cygwin & mingw for windows
* install eclipse

####二、 JNI简单实例：

* Step 1: Write a Java Class that uses C Codes - HelloJNI.java

```
public class HelloJNI {
   static {
      System.loadLibrary("hello"); // Load native library at runtime
                                   // hello.dll (Windows) or libhello.so (Unixes)
   }
 
   // Declare a native method sayHello() that receives nothing and returns void
   private native void sayHello();
 
   // Test Driver
   public static void main(String[] args) {
      new HelloJNI().sayHello();  // invoke the native method
   }
}
```

Compile the "HelloJNI.java" into "HelloJNI.class".

    > javac HelloJNI.java

* Step 2: Create the C/C++ Header file - HelloJNI.h

Run javah utility on the class file to create a header file for C/C++ programs:

      > javah HelloJNI

The output is HelloJNI.h as follows:

      /* DO NOT EDIT THIS FILE - it is machine generated */
      #include <jni.h>
      /* Header for class HelloJNI */
       
      #ifndef _Included_HelloJNI
      #define _Included_HelloJNI
      #ifdef __cplusplus
      extern "C" {
      #endif
      /*
       * Class:     HelloJNI
       * Method:    sayHello
       * Signature: ()V
       */
      JNIEXPORT void JNICALL Java_HelloJNI_sayHello(JNIEnv *, jobject);
       
      #ifdef __cplusplus
      }
      #endif
      #endif

> The arguments:

>> * JNIEnv*: reference to JNI environment, which lets you access all the JNI fucntions.
>> * jobject: reference to "this" Java object.

* Step 3: C Implementation - HelloJNI.c

Save the C program as "HelloJNI.c".

```
#include <jni.h>
#include <stdio.h>
#include "HelloJNI.h"
 
// Implementation of native method sayHello() of HelloJNI class
JNIEXPORT void JNICALL Java_HelloJNI_sayHello(JNIEnv *env, jobject thisObj) {
   printf("Hello World!\n");
   return;
}
```

Compile the C program - this depends on the C compiler you used.

*For MinGW GCC in Windows*

```
> set JAVA_HOME=C:\Program Files\Java\jdk1.7.0_{xx}
      // Define and Set environment variable JAVA_HOME to JDK installed directory
      // I recommend that you set JAVA_HOME permanently, via "Control Panel" ⇒ "System" ⇒ "Environment Variables"
> echo %JAVA_HOME%
      // In Windows, you can refer a environment variable by adding % prefix and suffix 
> gcc -Wl,--add-stdcall-alias -I"%JAVA_HOME%\include" -I"%JAVA_HOME%\include\win32" -shared -o hello.dll HelloJNI.c
      // Compile HellJNI.c into shared library hello.dll
```

You can also compile and link in two steps:

```
// Compile-only with -c flag. Output is HElloJNI.o
> gcc -c -I"%JAVA_HOME%\include" -I"%JAVA_HOME%\include\win32" HelloJNI.c
 
// Link into shared library "hello.dll"
> gcc -Wl,--add-stdcall-alias -shared -o hello.dll HelloJNI.o
```

**For Cygwin GCC in Windows**

For gcc-3, include option -mno-cygwin to build DLL files which are not dependent upon the Cygwin DLL.

> gcc-3 -D __int64="long long" -mno-cygwin -Wl,--add-stdcall-alias 
  -I"<JAVA_HOME>\include" -I"<JAVA_HOME>\include\win32" -shared -o hello.dll HelloJNI.c

**For gcc-4: I still cannot find the correct compiler option (-mno-cygwin is not supported). The Java program hangs!**

**相关网址**

[Java Native Interface Wiki](https://en.wikipedia.org/wiki/Java_Native_Interface#External_links "Markdown")
